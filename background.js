import{access_key}from"./key.js";chrome.commands.onCommand.addListener((e=>{"open_popup"===e&&chrome.action.openPopup().catch((e=>{}))}));const fetchRate=async(e,t)=>{let a=`${e}${t}`;const r=(new Date).toISOString().split("T")[0];let c=(await chrome.storage.local.get("pairs")).pairs||{};const s=c[a];if(s&&s.update?.startsWith(r))return{rate:s.rate,source:"cache (api.exchangerate.host)",reversed:s.reversed};try{const s=await fetch(`https://api.exchangerate.host/live?access_key=${access_key}&source=${e}&currencies=${t}&format=1`),o=await s.json();let n=!1;return a=o?.quotes?.[a]?a:(n=!0,`${t}${e}`),o?.quotes?.[a]?(async()=>{const e={update:r,rate:o?.quotes?.[a],reversed:n};return c[a]=e,await chrome.storage.local.set({pairs:c}),{rate:o.quotes[a],reversed:n,source:"direct (api.exchangerate.host)"}})():null}catch(e){return null}},dataGetter=async()=>(await chrome.storage.local.get("currLastSelected")).currLastSelected||{},dataSetter=async e=>{const t={...(await chrome.storage.local.get("currLastSelected")).currLastSelected||{},...e};await chrome.storage.local.set({currLastSelected:t})};chrome.runtime.onMessage.addListener(((e,t,a)=>{const r=[{type:"OPEN_EXT",action:()=>chrome.windows.create({url:chrome.runtime.getURL("popup.html"),type:"popup"})},{type:"GET_RATE",action:()=>fetchRate(e.asal,e.tujuan).then((e=>a(e)))},{type:"GET_LATEST_CURRS",action:()=>dataGetter().then((e=>a(e)))},{type:"SET_LATEST_CURRS",action:()=>dataSetter(e.data).then((()=>a({success:!0})))}].find((t=>t.type===e.type));if(r&&"function"==typeof r.action)return r.action(),!0}));