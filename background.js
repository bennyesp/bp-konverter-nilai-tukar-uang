import{access_key}from"./key.js";const xcnApiList=[{platform:"Exchangerate.host",platformId:"exchangeratehost",url:"https://api.exchangerate.host/live",keyParam:"access_key",baseParam:"source",targetParam:"currencies",otherParams:[{name:"format",value:"1"}]},{platform:"Currencylayer",platformId:"currencylayer",url:"https://api.currencylayer.com/live",keyParam:"access_key",baseParam:"source",targetParam:"currencies",otherParams:null}];chrome.commands.onCommand.addListener((e=>{"open_popup"===e&&chrome.action.openPopup().catch((e=>{}))}));const fetchRate=async(e,t,a)=>{let r=`${e}${t}`;const c=(new Date).toISOString().split("T")[0];let s=(await chrome.storage.local.get("pairs")).pairs||{};const o=s[r];if(o&&o.update?.startsWith(c))return{rate:o.rate,source:`cache (${o.source||""})`};const n=xcnApiList.find((e=>e.platformId===a));try{const o=new URLSearchParams;o.set(n.keyParam,access_key[a]),o.set(n.baseParam,e),o.set(n.targetParam,t),n.otherParams&&n.otherParams.length>0&&n.otherParams.forEach((e=>{o.set(e.name,e.value)}));const i=await fetch(`${n.url}?${o.toString()}`),l=await i.json();return r=l?.quotes?.[r]?r:`${t}${e}`,l?.quotes?.[r]?(async()=>{const e={update:c,rate:l.quotes[r],source:n.platform};return s[r]=e,await chrome.storage.local.set({pairs:s}),{rate:l.quotes[r],source:`direct (${n.platform})`}})():null}catch(e){return null}},dataGetter=async()=>(await chrome.storage.local.get("currLastSelected")).currLastSelected||{},dataSetter=async e=>{const t={...(await chrome.storage.local.get("currLastSelected")).currLastSelected||{},...e};await chrome.storage.local.set({currLastSelected:t})};chrome.runtime.onMessage.addListener(((e,t,a)=>{const r=[{type:"OPEN_EXT",action:()=>chrome.windows.create({url:chrome.runtime.getURL("popup.html"),type:"popup"})},{type:"GET_RATE",action:()=>fetchRate(e.asal,e.tujuan,e.selectedApi).then((e=>a(e)))},{type:"GET_LATEST_CURRS",action:()=>dataGetter().then((e=>a(e)))},{type:"SET_LATEST_CURRS",action:()=>dataSetter(e.data).then((()=>a({success:!0})))},{type:"GET_API_LIST",action:()=>a(xcnApiList)}].find((t=>t.type===e.type));if(r&&"function"==typeof r.action)return r.action(),!0}));